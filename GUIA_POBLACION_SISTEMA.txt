# ğŸ“‹ GUÃA COMPLETA PARA POBLAR EL SISTEMA BACKEND PARCIAL 1
# Fecha: 23 de Septiembre, 2025
# Repositorio: backendParcial1 (luisrepo25)

================================================================================
ğŸ¯ ÃNDICE
================================================================================
1. COMANDOS DE MANAGEMENT DE DJANGO
2. SECUENCIA RECOMENDADA PARA POBLAR EL SISTEMA
3. ENDPOINTS Y JSONSS PARA TESTING
4. RESUMEN DE DATOS GENERADOS

================================================================================
ğŸ“‹ 1. COMANDOS DE MANAGEMENT DE DJANGO DISPONIBLES
================================================================================

ğŸ” AUTHZ (Sistema de AutenticaciÃ³n y Propietarios)
--------------------------------------------------

1. CREAR ADMINISTRADOR
   python manage.py crear_admin --email admin@example.com --password admin123 --nombres Administrador --apellidos Sistema
   
   PropÃ³sito: Crea un usuario administrador con rol ADMIN
   ParÃ¡metros obligatorios: --email, --password, --nombres, --apellidos

2. CARGAR USUARIOS DESDE JSON
   python manage.py cargar_usuarios
   
   PropÃ³sito: Carga usuarios desde el archivo authz/initial_users.json
   Requiere: Archivo JSON con estructura de usuarios

3. CREAR USUARIOS PARA SISTEMA FACIAL
   python manage.py crear_usuarios_facial
   
   PropÃ³sito: Crea roles, personas y usuarios especÃ­ficos para reconocimiento facial
   Crea automÃ¡ticamente: Roles Administrador, Seguridad, Propietario, Inquilino

4. CREAR SOLICITUDES DE PROPIETARIOS DE PRUEBA
   python manage.py crear_solicitudes_propietarios --cantidad 10
   
   PropÃ³sito: Genera solicitudes de registro de propietarios de prueba
   ParÃ¡metro opcional: --cantidad (default: 5)

5. SETUP DATOS DE PRUEBA PARA REGISTRO
   python manage.py setup_registro_test --num-viviendas 20 --num-solicitudes 10
   
   PropÃ³sito: Crea viviendas y solicitudes de prueba completas
   ParÃ¡metros opcionales:
   - --num-viviendas (default: 10)
   - --num-solicitudes (default: 5)

6. APROBAR SOLICITUD DESDE LÃNEA DE COMANDOS
   python manage.py aprobar_solicitud 1 --admin-user admin@example.com --observaciones "Aprobado desde comandos"
   
   PropÃ³sito: Aprueba una solicitud especÃ­fica por ID
   ParÃ¡metros:
   - solicitud_id (obligatorio)
   - --admin-user (opcional)
   - --observaciones (opcional)

ğŸ¢ CORE (GestiÃ³n de Viviendas y Propiedades)
--------------------------------------------

7. CREAR DATOS DE PRUEBA CU05
   python manage.py crear_datos_prueba_cu05
   
   PropÃ³sito: Crea datos completos de prueba para gestiÃ³n de unidades habitacionales
   Incluye: Usuario admin, viviendas, personas y propiedades

ğŸ” SEGURIDAD (Reconocimiento Facial)
------------------------------------

8. CREAR DATOS DE PRUEBA FACIAL
   python manage.py create_test_data
   
   PropÃ³sito: Crea copropietarios de prueba para sistema de reconocimiento facial
   Integra: Con usuarios del sistema authz

================================================================================
ğŸ¯ 2. SECUENCIA RECOMENDADA PARA POBLAR TODO EL SISTEMA
================================================================================

PASO 1: CONFIGURACIÃ“N BASE
---------------------------
# 1. Aplicar migraciones
python manage.py migrate

# 2. Crear administrador principal
python manage.py crear_admin --email admin@condominio.com --password admin123 --nombres Admin --apellidos Sistema

PASO 2: DATOS DE VIVIENDAS Y PROPIEDADES
----------------------------------------
# 3. Crear datos base de viviendas y propiedades
python manage.py crear_datos_prueba_cu05

PASO 3: SISTEMA DE USUARIOS Y ROLES
------------------------------------
# 4. Crear usuarios para sistema facial
python manage.py crear_usuarios_facial

# 5. Configurar datos de registro de propietarios
python manage.py setup_registro_test --num-viviendas 15 --num-solicitudes 8

PASO 4: SOLICITUDES Y APROBACIONES
-----------------------------------
# 6. Crear solicitudes adicionales de prueba
python manage.py crear_solicitudes_propietarios --cantidad 5

# 7. Aprobar algunas solicitudes manualmente (opcional)
python manage.py aprobar_solicitud 1 --admin-user admin@condominio.com
python manage.py aprobar_solicitud 2 --admin-user admin@condominio.com

PASO 5: SISTEMA DE RECONOCIMIENTO FACIAL
-----------------------------------------
# 8. Crear datos de prueba para reconocimiento facial
python manage.py create_test_data

================================================================================
ğŸ“ 3. ENDPOINTS Y JSONS PARA TESTING
================================================================================

ğŸ” AUTENTICACIÃ“N Y AUTORIZACIÃ“N
--------------------------------

LOGIN
URL: POST /api/authz/login/
JSON:
{
  "email": "usuario@example.com",
  "password": "contraseÃ±a123"
}

REFRESH TOKEN
URL: POST /api/authz/refresh/
JSON:
{
  "refresh": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
}

REGISTRO DE USUARIO GENERAL
URL: POST /api/authz/register/
JSON:
{
  "nombre": "Ana Gomez",
  "email": "ana@example.com",
  "password": "SecretPass123",
  "password_confirm": "SecretPass123",
  "telefono": "71111111"
}

ğŸ  REGISTRO DE PROPIETARIOS
---------------------------

REGISTRO INICIAL DE PROPIETARIO
URL: POST /api/authz/propietarios/registro-inicial/
JSON:
{
  "primer_nombre": "Juan",
  "primer_apellido": "PÃ©rez",
  "cedula": "12345678",
  "fecha_nacimiento": "1985-06-15",
  "telefono": "71234567",
  "email": "juan.perez@example.com",
  "numero_casa": "A-101",
  "password": "MiPassword123",
  "confirm_password": "MiPassword123"
}

CREAR SOLICITUD DE REGISTRO (PROPIETARIO)
URL: POST /api/authz/propietarios/solicitudes/
JSON:
{
  "nombre": "MarÃ­a",
  "apellido": "GonzÃ¡lez", 
  "documento_identidad": "87654321",
  "fecha_nacimiento": "1990-03-20",
  "email": "maria.gonzalez@example.com",
  "telefono": "72345678",
  "numero_casa": "B-205",
  "comentarios": "Solicito ser registrada como propietaria"
}

APROBAR SOLICITUD (Administrador)
URL: POST /api/authz/propietarios/admin/solicitudes/{id}/aprobar/
JSON:
{
  "observaciones_aprobacion": "Solicitud aprobada - documentaciÃ³n completa"
}

IMPORTANTE: âœ… Al aprobar una solicitud:
- Se crea automÃ¡ticamente un Usuario asociado
- Se asigna el ROL DE PROPIETARIO automÃ¡ticamente  
- Se crea la relaciÃ³n con la Vivienda
- Se actualiza el estado a 'APROBADA'
- Se registra la fecha y usuario que aprobÃ³

RECHAZAR SOLICITUD (Administrador)
URL: POST /api/authz/propietarios/admin/solicitudes/{id}/rechazar/
JSON:
{
  "motivo_rechazo": "DocumentaciÃ³n incompleta",
  "comentarios_admin": "Falta comprobante de propiedad"
}

ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ GESTIÃ“N DE FAMILIARES (Panel Propietario)
--------------------------------------------------

REGISTRAR FAMILIAR
URL: POST /api/authz/propietarios/familiares/
AutenticaciÃ³n: JWT Token requerido
JSON:
{
  "primer_nombre": "Carlos",
  "primer_apellido": "PÃ©rez",
  "documento_identidad": "11223344",
  "fecha_nacimiento": "2000-08-10",
  "telefono": "73456789",
  "email": "carlos.perez@example.com",
  "relacion_familiar": "hijo",
  "es_menor_edad": false,
  "documento_autorizacion": "base64_encoded_file_here"
}

ğŸ˜ï¸ GESTIÃ“N DE INQUILINOS (Panel Propietario)
---------------------------------------------

REGISTRAR INQUILINO
URL: POST /api/authz/propietarios/inquilinos/
AutenticaciÃ³n: JWT Token requerido
JSON:
{
  "primer_nombre": "Ana",
  "primer_apellido": "MartÃ­nez", 
  "documento_identidad": "55667788",
  "fecha_nacimiento": "1988-12-05",
  "telefono": "74567890",
  "email": "ana.martinez@example.com",
  "fecha_inicio": "2025-01-01",
  "fecha_fin": "2025-12-31",
  "monto_alquiler": "1500.00",
  "observaciones": "Inquilino principal - contrato anual",
  "contrato_alquiler": "base64_encoded_file_here"
}

ğŸ¢ GESTIÃ“N DE VIVIENDAS
-----------------------

CREAR VIVIENDA
URL: POST /api/viviendas/viviendas/
JSON:
{
  "numero_casa": "C-301",
  "bloque": "C",
  "tipo_vivienda": "apartamento",
  "area_m2": 85.5,
  "numero_habitaciones": 3,
  "numero_banos": 2,
  "tiene_parqueadero": true,
  "piso": 3,
  "estado": "ocupado"
}

CREAR PROPIEDAD
URL: POST /api/viviendas/propiedades/
JSON:
{
  "vivienda": 1,
  "persona": 1,
  "tipo_relacion": "propietario",
  "fecha_inicio": "2024-01-01",
  "porcentaje_propiedad": "100.00",
  "es_principal": true,
  "activo": true
}

CREAR PERSONA (Core)
URL: POST /api/viviendas/personas/
JSON:
{
  "nombre": "Roberto",
  "apellido": "Silva",
  "documento_identidad": "99887766",
  "telefono": "75678901",
  "email": "roberto.silva@example.com",
  "fecha_nacimiento": "1975-04-18",
  "genero": "M"
}

ğŸ’° GESTIÃ“N DE PAGOS
-------------------

REGISTRAR PAGO
URL: POST /api/pagos/procesar/
AutenticaciÃ³n: JWT Token requerido
JSON:
{
  "tipo_deuda": "expensa",
  "deuda_id": 1,
  "monto": "250.00",
  "metodo_pago": "transferencia",
  "referencia_transaccion": "TXN-2025-001",
  "comentarios": "Pago de expensa mensual enero 2025"
}

GENERAR DATOS DEMO
URL: POST /api/pagos/demo/
AutenticaciÃ³n: JWT Token requerido
JSON:
{
  "cantidad_expensas": 3,
  "cantidad_multas": 1,
  "monto_expensa": "200.00",
  "monto_multa": "50.00"
}

ğŸ” RECONOCIMIENTO FACIAL
------------------------

ENROLAMIENTO DE ROSTRO
URL: POST /api/seguridad/api/faces/enroll/
Formato: multipart/form-data
JSON:
{
  "copropietario_id": 1,
  "imagen": "archivo_imagen.jpg"
}

VERIFICACIÃ“N DE ROSTRO
URL: POST /api/seguridad/api/faces/verify/
Formato: multipart/form-data
JSON:
{
  "copropietario_id": 1,
  "imagen": "archivo_imagen.jpg"
}

ELIMINAR ENROLAMIENTO
URL: DELETE /api/seguridad/api/faces/enroll/{copropietario_id}/

ğŸ“Š CONSULTAS Y LISTAS
---------------------

CONSULTAR ESTADO DE SOLICITUD (PÃºblico)
URL: GET /api/authz/propietarios/solicitudes/status/{token}/

LISTAR SOLICITUDES PENDIENTES (Administrador)
URL: GET /api/authz/propietarios/admin/solicitudes/

MENU DEL PROPIETARIO
URL: GET /api/authz/propietarios/menu/
AutenticaciÃ³n: JWT Token requerido

LISTAR FAMILIARES
URL: GET /api/authz/propietarios/familiares/
AutenticaciÃ³n: JWT Token requerido

LISTAR INQUILINOS
URL: GET /api/authz/propietarios/inquilinos/
AutenticaciÃ³n: JWT Token requerido

LISTAR DEUDAS PENDIENTES
URL: GET /api/pagos/deudas/
AutenticaciÃ³n: JWT Token requerido

ğŸ”§ GESTIÃ“N DE USUARIOS Y ROLES
-------------------------------

CREAR ROL
URL: POST /api/authz/roles/
JSON:
{
  "nombre": "Propietario",
  "descripcion": "Propietario de unidad habitacional",
  "activo": true
}

CAMBIAR CONTRASEÃ‘A
URL: POST /api/authz/change-password/
AutenticaciÃ³n: JWT Token requerido
JSON:
{
  "password_actual": "contraseÃ±a_actual",
  "password_nueva": "nueva_contraseÃ±a123",
  "password_nueva_confirm": "nueva_contraseÃ±a123"
}

SOLICITAR RECUPERACIÃ“N DE CONTRASEÃ‘A
URL: POST /api/authz/solicitar-recuperacion-password/
JSON:
{
  "email": "usuario@example.com"
}

================================================================================
ğŸ“Š 4. RESUMEN DE DATOS GENERADOS
================================================================================

DATOS GENERADOS POR COMANDO:
-----------------------------
â”‚ Comando                          â”‚ Usuarios â”‚ Viviendas â”‚ Solicitudes â”‚ Copropietarios â”‚ Roles â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ crear_admin                     â”‚ 1 admin  â”‚ -         â”‚ -           â”‚ -              â”‚ 3     â”‚
â”‚ crear_datos_prueba_cu05         â”‚ ~11      â”‚ ~20       â”‚ -           â”‚ -              â”‚ -     â”‚
â”‚ crear_usuarios_facial           â”‚ ~8       â”‚ -         â”‚ -           â”‚ -              â”‚ 4     â”‚
â”‚ setup_registro_test             â”‚ -        â”‚ 10-20     â”‚ 5-10        â”‚ -              â”‚ -     â”‚
â”‚ crear_solicitudes_propietarios  â”‚ -        â”‚ -         â”‚ 5+          â”‚ -              â”‚ -     â”‚
â”‚ create_test_data                â”‚ -        â”‚ -         â”‚ -           â”‚ ~6             â”‚ -     â”‚

TOTAL ESTIMADO DESPUÃ‰S DE EJECUTAR TODOS:
------------------------------------------
ğŸ‘¥ Usuarios: ~20 usuarios diversos
ğŸ  Viviendas: ~35 viviendas 
ğŸ“ Solicitudes: ~15-20 solicitudes
ğŸ‘¤ Copropietarios: ~6 para facial
ğŸ­ Roles: 4 roles principales

RESUMEN POR CATEGORÃA DE ENDPOINTS:
-----------------------------------
â”‚ CategorÃ­a              â”‚ Cantidad de Endpoints â”‚ AutenticaciÃ³n Requerida â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AutenticaciÃ³n         â”‚ 3                    â”‚ No                      â”‚
â”‚ Registro Propietarios â”‚ 5                    â”‚ Parcial (admin sÃ­)      â”‚
â”‚ GestiÃ³n Familiares    â”‚ 2                    â”‚ SÃ­ (JWT)                â”‚
â”‚ GestiÃ³n Inquilinos    â”‚ 2                    â”‚ SÃ­ (JWT)                â”‚
â”‚ GestiÃ³n Viviendas     â”‚ 6                    â”‚ SÃ­                      â”‚
â”‚ Pagos                 â”‚ 3                    â”‚ SÃ­ (JWT)                â”‚
â”‚ Reconocimiento Facial â”‚ 4                    â”‚ SÃ­                      â”‚
â”‚ Consultas             â”‚ 6                    â”‚ Parcial                 â”‚
â”‚ AdministraciÃ³n        â”‚ 4                    â”‚ SÃ­                      â”‚

Total: 35+ endpoints que requieren JSONs especÃ­ficos para poblar y probar el sistema completo.

================================================================================
ğŸ“ NOTAS IMPORTANTES
================================================================================

1. ORDEN DE EJECUCIÃ“N: Seguir la secuencia recomendada para evitar errores de dependencias.

2. AUTENTICACIÃ“N: Muchos endpoints requieren JWT tokens. Obtener tokens con el endpoint de login primero.

3. ARCHIVOS: Algunos endpoints requieren archivos en base64 o multipart/form-data.

4. TESTING: Usar Postman, Insomnia o curl para probar los endpoints con los JSONs proporcionados.

5. ADMINISTRACIÃ“N: Los endpoints de administraciÃ³n requieren usuarios con rol de administrador.

6. MIGRACIONES: Si aparecen errores relacionados con columnas faltantes (como vivienda_validada_id), 
   ejecutar: python manage.py migrate para aplicar las migraciones mÃ¡s recientes.

7. ESTADO ACTUALIZADO: Todos los comandos han sido probados y funcionan correctamente (23/09/2025).

ğŸš¨ ERRORES COMUNES Y SOLUCIONES:
-------------------------------

ERROR: "Esta cÃ©dula ya estÃ¡ registrada"
CAUSA: La cÃ©dula ya existe en la base de datos
SOLUCIÃ“N: Usar una cÃ©dula diferente o verificar con:
python manage.py shell -c "from authz.models import Persona; [print(f'{p.documento_identidad}: {p.nombre}') for p in Persona.objects.all()]"

ERROR: "No existe la vivienda X en el sistema"  
CAUSA: El numero_casa no existe en las viviendas disponibles
SOLUCIÃ“N: Verificar viviendas disponibles con:
python manage.py shell -c "from core.models import Vivienda; [print(v.numero_casa) for v in Vivienda.objects.all()]"

ERROR: "Usuario NO tiene solicitud aprobada" (Status 403)
CAUSA: Falta asociaciÃ³n entre usuario y solicitud, o solicitud no aprobada
SOLUCIÃ“N: 
- Verificar que la solicitud estÃ© aprobada
- Ejecutar: python manage.py aprobar_solicitud <ID> --admin-user <email_admin>

ERROR: "UNIQUE constraint failed: authz_persona.documento_identidad"
CAUSA: Se intenta crear una persona que ya existe en el sistema
SOLUCIÃ“N AUTOMÃTICA: âœ… El sistema ahora maneja automÃ¡ticamente este caso:
- Si existe la persona con la misma cÃ©dula Y email, reutiliza el usuario existente
- Solo asigna el rol de Propietario si no lo tiene
- Si existe la cÃ©dula pero con diferente email, muestra error descriptivo

ERROR: "La vivienda X ya tiene un propietario registrado"
CAUSA: La vivienda solicitada ya estÃ¡ ocupada por otro propietario
SOLUCIÃ“N: Cambiar el numero_casa de la solicitud a una vivienda libre:
python manage.py shell -c "
from authz.models import *
solicitud = SolicitudRegistroPropietario.objects.get(id=X)
solicitud.numero_casa = 'VIVIENDA_LIBRE'
solicitud.save()
"

VERIFICAR VIVIENDAS LIBRES:
python manage.py shell -c "
from core.models import *
libres = []
for v in Vivienda.objects.all():
    props = Propiedad.objects.filter(vivienda=v, tipo_tenencia='propietario')
    if not props.exists(): libres.append(v.numero_casa)
print(f'Viviendas libres: {libres[:10]}')
"

âœ… FUNCIONALIDD CONFIRMADA - ASIGNACIÃ“N AUTOMÃTICA DE ROLES:
-----------------------------------------------------------
Cuando un administrador aprueba una solicitud de propietario:
1. Se crea automÃ¡ticamente un Usuario con email/contraseÃ±a
2. Se asigna el ROL DE PROPIETARIO automÃ¡ticamente
3. Se crea la asociaciÃ³n con la Vivienda solicitada  
4. Se actualiza el estado a 'APROBADA'
5. El propietario puede inmediatamente acceder al panel con sus permisos

COMPROBACIÃ“N:
python manage.py shell -c "
from authz.models import *
usuario = Usuario.objects.get(email='email_del_propietario')
print(f'Roles: {[rol.nombre for rol in usuario.roles.all()]}')
"

VIVIENDAS DISPONIBLES DESPUÃ‰S DE COMANDOS DE PRUEBA:
V001, V002, V003, V004, V005 (entre otras)

USUARIOS DE PRUEBA CREADOS:
- admin@facial.com / admin123 (Administrador)
- blancobautistaluisfernando@gmail.com / cliente123 (Propietario aprobado)

================================================================================
Fin de la GuÃ­a - Generado el 23 de Septiembre, 2025 
âœ… CONFIRMADO: AsignaciÃ³n automÃ¡tica de roles al aprobar solicitudes
================================================================================

ğŸ¯ RESUMEN EJECUTIVO - FUNCIONALIDAD DE APROBACIÃ“N:
--------------------------------------------------
âœ… API Endpoint: POST /api/authz/propietarios/admin/solicitudes/{id}/aprobar/
âœ… Comando CLI: python manage.py aprobar_solicitud {id} --admin-user {email}
âœ… MÃ©todo Modelo: solicitud.aprobar_solicitud(admin_user)

TODOS ASIGNAN AUTOMÃTICAMENTE:
- Rol de "Propietario" al usuario
- Usuario y contraseÃ±a funcional
- AsociaciÃ³n con vivienda solicitada
- Estado "APROBADA" en la solicitud

USUARIOS DE PRUEBA CONFIRMADOS:
- pedro.lÃ³pez1@test.com (V001) âœ…
- suarezburgoshebert@gmail.com (V002) âœ…
- pedro.sÃ¡nchez2@test.com (V003) âœ… 
- pedro.lÃ³pez3@test.com (V004) âœ…
- marÃ­a.martÃ­nez4@test.com (V005) âœ…
- luis.martÃ­nez5@test.com (V006) âœ…
- maria.gonzalez@facial.com (usuario existente) âœ…

TOTAL: 7 usuarios con rol "Propietario" - Todos con acceso al panel.

ğŸ”§ PROBLEMA RESUELTO - GESTIÃ“N DE CONFLICTOS:
--------------------------------------------
âœ… UNIQUE constraint fixed: El sistema ahora maneja automÃ¡ticamente duplicados
âœ… ReutilizaciÃ³n de usuarios: Si existe persona+email, asigna rol sin crear duplicado  
âœ… ValidaciÃ³n de viviendas: Verifica que la vivienda estÃ© libre antes de asignar
âœ… Mensajes descriptivos: Errores claros cuando hay conflictos irresolubles

================================================================================